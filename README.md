# sirius-nlp
Решение кейса от Т-банка по классификации отзывов на маркетплейсах

# Решение

### Общий ход решения

1. Разметить тренировочный датасет самыми умными моделями учителями, причем попросить LLM выдать не только категории, но и `confidence_score` - степерь уверенности LLM в своём ответе.
2. Дообучить одного из учителей или более быструю LLM на размеченном всеми учителями датасете, учитывая согласовонность labels от разных учителей и `confidence_score`.
3. На тестовом датасете использовать гибридный подход: большинство случаев размечать дообученной быстрой LLM, а в "сложных" случаях обращаться к учителям

### 1) EDA и разметка тренировочного датасета

Прежде чем размечать тренировочный датасет, мы немного разобрались с данными, с которыми работаем. Список категорий:
 1. Бытовая техника
 2. Обувь
 3. Одежда
 4. Посуда
 5. Текстиль
 6. Товары для детей
 7. Украшения и аксессуары
 8. Электроника
 9. Нет товара

<img width="695" height="393" alt="image" src="https://github.com/user-attachments/assets/2f7b163f-12de-4713-a47c-323be7520b8a" />

Распределения схожи, максимальная длина отзыва также примерно одинакова в тренировочных и тестовых данных, так что проблем возникнуть не должно. Все отзывы небольшие, поэтому специальная обрезка или предобработка, чтобы озыв всегда влезал в контекст, не требуется.

Ручная разметка данных не рекомендуется, однако, чтобы в дальнейшем выбирать моделди, используя data-driven подход, нам необходим небольшой датасет для валидации, в котором мы уверены. Поэтому было принято решение вручную найти несколько отзывов из каждой категории. Это — меньшая часть тренировочного датасета и занимает не так много времени, однако позволяет нам лучше разобраться с данными и не действовать "вслепую".

**В данных была обнаружена проблема: большая часть отзывов в train — это отзывы об одежде. Отзывов о бытовой технике, обуви, посуде, текстиле, электронике и украшениях/аксессуарах фактически нет.**

Отзывы в размеченном датасете:

<img width="629" height="470" alt="image" src="https://github.com/user-attachments/assets/9a8f9d04-7f8e-45f1-a9bb-4e5301fca3a0" />

Поэтому мы сгенерировали синтетические данные для всех остальных категорий, используя следующий промпт:

```python
PROMPT_TEMPLATE = """
Ты — ассистент, который помогает создавать реалистичные отзывы для обучающего датасета.
Твоя задача — сгенерировать {n_examples} новых, уникальных, но похожих по стилю отзывов для категории «{category}».
Отзывы должны быть разнообразными: разной длины, с разным настроением (положительные, отрицательные, смешанные), иногда с упоминанием доставки, но с фокусом на сам товар.

Вот пример отзыва для этой категории:
"{example_text}"

Верни ровно {n_examples} отзывов в виде нумерованного списка. Каждый отзыв на новой строке.
"""

CATEGORIES_TO_GENERATE = {
    "бытовая техника": "Кофемашина огонь! Кофе вкусный, пенка плотная. Единственный минус — немного шумная по утрам.",
    "обувь": "Кроссовки подошли по размеру, очень легкие и удобные. Доставили на день раньше, что приятно. Посмотрим, как поведут себя в носке.",
    "посуда": "Сковорода с антипригарным покрытием, ничего не прилипает. Но ручка кажется немного хлипкой, боюсь, как бы не отвалилась.",
    "текстиль": "Комплект постельного белья красивый, цвет как на фото. После первой стирки не сел и не полинял. Ткань немного жестковата, надеюсь, со временем станет мягче.",
    "товары для детей": "Конструктор сыну очень понравился, сидит собирает уже второй час. Детали качественные, без запаха. Коробка пришла чуть помятая, но внутри все целое.",
    "украшения и аксессуары": "Сумка выглядит дороже своей цены. Фурнитура качественная, все замки работают. Немного меньше, чем я ожидала, ноутбук не влезает, но для прогулок — идеально.",
    "электроника": "Наушники топ за свои деньги. Звук чистый, басы глубокие. В ушах сидят отлично, не выпадают при беге. Заряд держат честно 5 часов."
}
```
Синтетические отзывы получились странноватые, но для задачи оценки "учителей" это не критично.

По итогам исследования бенчмарков и предварительного тестирования в качестве учителей были выбраны 4 модели (по техническим причинам, модель gemma была протестирована в отдельном ноутбуке):

- `Vikhrmodels/Vikhr-Nemo-12B-Instruct-R-21-09-24` (в дальнейшем заменили на более актуальную модель от Vikhrmodels - `Vikhrmodels/QVikhr-3-8B-Instruction`)
- `Qwen/Qwen3-4B-Instruct-2507`
- `google/gemma-3-12b-it`


Эти модели отличаются архитектурами и датасетами, на которых они обучались, поэтому можно ожидать, что они совершают разные ошибки, поэтому голосование таких моделей позволит разметить датасет качественно. F1 score всех этих моделей был низким, однако для экономии времени мы приняли решение не зацикливаться на тестировании учителей и идти дальше. Vikhrmodels - это серия моделей, дообученных на русскоязычных датасетах.

EDA и тестирование моделей-учителей были проведены на платформе Kaggle: [Intro and teacher models comparison](https://www.kaggle.com/code/dreamtim1/intro-and-teacher-models-comparison) (в разных версиях ноутбука были использованы разные модели).

Далее датасет [был размечен всеми тремя учителями](https://www.kaggle.com/code/dreamtim1/teachers-on-full-dataset/edit) и на основе этого датасета, а также синтетических отзывов от всех трех учителей, был сформирован тренировочный датасет для роутера.

### 2) Дообучение роутера на основе gemma-2b (QLoRA) 

Чтобы быстро и качественно классифицировать большинство отзывов, [мы разработали модель-роутер](https://www.kaggle.com/code/dreamtim1/final-solution), которая способна классифицировать отзывы в 3 категории: одежда, нет товара и ДРУГОЕ. Датасет был сформирован следующим образом:

- Категория "одежда" и "нет товара" - это те отзывы из тренировочного датасета, где все три учителя предсказали данную категорию, причем у хотя бы одной из моделей `confidence_score` выше 0.9
- Категория "ДРУГОЕ" - это остальные "сложные" отзывы
- Чтобы научить роутер работать с категориями, которых нет в тренировочном датасете, категория "ДРУГОЕ" была обогощена синтетическими отзывами: по 20 отзывов от каждого из учителей на каждую отсутствующую категорию. Несколько учителей было использовано, чтобы не привязываться к "стилю" конкретной модели

### 3) Разметка тестового даатасета с помощью гидридной схемы

- Мы разметили тестовый датасет по следующей схеме: сначала отрабатывает роутер, а для категории "ДРУГОЕ" итоговая метка выбирается путем взвешенного по уровню уверенности голосвания моделей-учитилей
- Время работы роутера, согласно нашим экспериментам - 1.2 сек, среднее время на один отзыв - 4.7 сек.
